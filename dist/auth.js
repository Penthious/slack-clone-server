'use strict';Object.defineProperty(exports,'__esModule',{value:!0}),exports.addUser=exports.tryLogin=exports.refreshTokens=exports.createTokens=void 0;var _jsonwebtoken=require('jsonwebtoken'),_jsonwebtoken2=_interopRequireDefault(_jsonwebtoken),_bcrypt=require('bcrypt'),_bcrypt2=_interopRequireDefault(_bcrypt),_config=require('./config'),_config2=_interopRequireDefault(_config),_Models=require('./Models'),_Models2=_interopRequireDefault(_Models);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const createTokens=exports.createTokens=async(a,b,c)=>{const{id:d,username:e}=a,f=_jsonwebtoken2.default.sign({user:{id:d,username:e}},b,{expiresIn:'6h'}),g=_jsonwebtoken2.default.sign({user:{id:d}},c,{expiresIn:'7d'});return[f,g]},refreshTokens=exports.refreshTokens=async(a,b,c,d,e)=>{let f=-1;try{const{user:{id:a}}=_jsonwebtoken2.default.decode(b);f=a}catch(a){return{}}if(!f)return{};const g=await c.User.findOne({where:{id:f},raw:!0});if(!g)return{};const h=g.password+e;try{_jsonwebtoken2.default.verify(b,h)}catch(a){return{}}const[i,j]=await createTokens(g,d,h);return{token:i,refreshToken:j,user:g}},tryLogin=exports.tryLogin=async(a,b,c,d,e)=>{const f=await c.User.findOne({where:{email:a},raw:!0});if(!f)return{ok:!1,errors:[{path:'email',message:'Invalid Creds'}]};const g=await _bcrypt2.default.compare(b,f.password);if(!g)return{ok:!1,errors:[{path:'password',message:'Invalid Creds'}]};const[h,i]=await createTokens(f,d,f.password+e);return{ok:!0,token:h,refreshToken:i}},addUser=exports.addUser=async(a,b,c)=>{const d=a.headers['x-token'];if(d)try{const{user:b}=_jsonwebtoken2.default.verify(d,_config2.default.SECRET);a.user=b}catch(c){const c=a.headers['x-refresh-token'],e=await refreshTokens(d,c,_Models2.default,_config2.default.SECRET,_config2.default.SECRET2);e.token&&e.refreshToken&&(b.set('Access-Control-Expose-Headers','x-token, x-refresh-token'),b.set('x-token',e.token),b.set('x-refresh-token',e.refreshToken)),a.user=e.user}c()};